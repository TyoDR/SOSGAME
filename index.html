<!doctype html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game SOS Multiplayer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            --board-bg-page: #f0f8ff;
            --cell-content-bg: #ffffff;
            --grid-lines-color: #333333;
            --cell-number-color: #b0b0b0;
            --player1-color-text: #007bff;
            --player1-color-line: #0056b3;
            --player2-color-text: #d93025;
            --player2-color-line: #b21b10;
            --score-bubble-p1-bg: #007bff;
            --score-bubble-p2-bg: #d93025;
            --score-text-color: #ffffff;
            --vs-text-color: #555555;
            --text-dark: #333333;
            --text-light: #ffffff;
            --button-choice-bg: #ffffff;
            --button-choice-active-bg: #e0f7fa;
            --button-choice-active-border: #00acc1;
            --button-choice-border: #cccccc;
            --button-choice-text-color: #555555;
            --label-sos-text: #007bff;
            --label-sos-border: #007bff;
            --last-move-highlight-bg: #fff352;
            --admin-button-bg: #6c757d;
            --admin-button-hover-bg: #5a6268;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --grid-gap: 3px;
            --button-action-green: #4CAF50;
            --button-action-green-hover: #45a049;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: var(--board-bg-page);
            color: var(--text-dark);
            padding: 15px;
        }

        /* CSS untuk Login Section */
        .section-container {
            width: 100%; max-width: 480px; background-color: #fff;
            padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-container h2 { margin-bottom: 15px; text-align: center; }
        .section-container input[type="text"] {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ccc; border-radius: 4px; font-size: 1em;
        }
        .section-container button {
            width: 100%; padding: 10px 15px; font-size: 1em; cursor: pointer;
            background-color: var(--admin-button-bg); color: white;
            border: none; border-radius: 4px; margin-top: 5px;
        }
        .section-container button:hover { background-color: var(--admin-button-hover-bg); }
        .section-container button.action-green { background-color: var(--button-action-green); }
        .section-container button.action-green:hover { background-color: var(--button-action-green-hover); }
        .section-container button:disabled { background-color: #ccc; cursor: not-allowed; }
        #availableGames { margin-top: 0px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; display: none; background-color: #f9f9f9; }
        #availableGames ul { list-style-type: none; padding: 0; margin: 0; }
        #availableGames li { padding: 8px 5px; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #availableGames li:last-child { border-bottom: none; }
        .join-lobby-btn { background-color: var(--button-action-green) !important; color: white !important; padding: 4px 8px !important; font-size: 0.85em !important; margin-left: 10px !important; border-radius: 3px !important; border: none !important; cursor: pointer !important; width: auto !important; margin-top: 0 !important; }
        .join-lobby-btn:hover { background-color: var(--button-action-green-hover) !important; }

        /* CSS untuk Game Section */
        .score-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 480px;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .player-score { display: flex; align-items: center; font-weight: 600; font-size: 0.9em; }
        .player-score .name { margin: 0 8px; }
        .player-score .score-bubble { width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--score-text-color); font-weight: 700; font-size: 1.1em; }
        .player-score.blue .name { color: var(--player1-color-text); }
        .player-score.blue .score-bubble { background-color: var(--score-bubble-p1-bg); }
        .player-score.red .name { color: var(--player2-color-text); }
        .player-score.red .score-bubble { background-color: var(--score-bubble-p2-bg); }
        .vs-separator { font-weight: 700; font-size: 1.2em; color: var(--vs-text-color); }

        #gameIdDisplay {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--text-dark);
            font-size: 0.9em;
        }
        #messages {
            text-align: center;
            font-weight: 500;
            min-height: 1.2em;
            margin-bottom: 10px;
            width: 100%;
            max-width: 480px;
        }
        #messages.hidden-info { display: none !important; }

        .board-area { display: flex; justify-content: center; align-items: center; width: 100%; max-width: 480px; min-width: 300px; }
        .board-container { position: relative; display: grid; gap: var(--grid-gap); background-color: var(--grid-lines-color); border: 5px solid var(--grid-lines-color); box-shadow: 0 2px 8px var(--shadow-light); width: 100%; aspect-ratio: 1 / 1; }
        .board-cell { background-color: var(--cell-content-bg); display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: background-color 0.2s; color: var(--cell-number-color); -webkit-user-select: none; -ms-user-select: none; user-select: none; }
        .board-cell.last-move-highlight { background-color: var(--last-move-highlight-bg) !important; }
        .board-cell.player1-text { color: var(--player1-color-text) !important; }
        .board-cell.player2-text { color: var(--player2-color-text) !important; }
        .board-cell.filled { cursor: default; }
        .board-cell:hover:not(.filled) { background-color: #f0f0f0; }

        .line-overlay { position: absolute; pointer-events: none; }
        .line-overlay line { stroke-linecap: round; }

        #turnInfoDisplay { text-align: center; font-weight: 600; margin-top:15px; font-size: 1em; color: var(--vs-text-color); min-height: 1.2em; }

        .game-controls-bottom { display: flex; justify-content: center; align-items: center; width: 100%; max-width: 480px; padding: 20px 0; gap: 20px; margin-top: 10px; }
        .label-sos { font-size: 0.9em; font-weight: 700; color: var(--label-sos-text); border: 2px solid var(--label-sos-border); padding: 6px 12px; border-radius: 18px; text-transform: uppercase; }
        .letter-buttons-bottom { display: flex; gap: 15px; }
        .letter-btn-bottom { font-family: 'Poppins', sans-serif; font-size: 1.8em; font-weight: 600; width: 60px; height: 60px; border: 2px solid var(--button-choice-border); border-radius: 50%; cursor: pointer; color: var(--button-choice-text-color); background-color: var(--button-choice-bg); display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s; }
        .letter-btn-bottom:hover:not(.active) { border-color: #a0a0a0; }
        .letter-btn-bottom.active { background-color: var(--button-choice-active-bg); border-color: var(--button-choice-active-border); box-shadow: 0 0 8px var(--button-choice-active-border); }

        .admin-controls { margin-top: 15px; display: flex; gap: 15px; justify-content: center; align-items: center; width: 100%; max-width: 480px; }
        #resetGame, #leaveGameBtn { font-family: 'Poppins', sans-serif; font-size: 0.9em; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: var(--text-light); transition: background-color 0.3s; }
        #resetGame { background-color: var(--admin-button-bg); }
        #resetGame:hover { background-color: var(--admin-button-hover-bg); }
        #leaveGameBtn { background-color: #d9534f; }
        #leaveGameBtn:hover { background-color: #c9302c; }
    </style>
</head>
<body>
    <div id="loginSection" class="section-container">
        <h2>Game SOS Multiplayer</h2>
        <input type="text" id="playerNameInput" placeholder="Masukkan Nama Anda">
        <button id="showAvailableGamesBtn" class="action-green" style="margin-bottom: 10px;">Lihat Game Tersedia</button>
        <div id="availableGames">
            <p><i>Memuat game... (atau tidak ada game)</i></p>
        </div>
        <input type="text" id="gameIdInput" placeholder="Masukkan ID Game (jika bergabung)">
        <button id="joinOrCreateGameBtn" class="action-green">Gabung / Buat Game Baru</button>
    </div>

    <div id="gameSection" style="display:none; flex-direction: column; align-items: center; width:100%;">
        <div class="score-bar">
            <div class="player-score blue"> <span class="name" id="player1NameDisplay">Pemain 1</span>
                <div class="score-bubble" id="scoreP1Display">0</div>
            </div>
            <div class="vs-separator">VS</div>
            <div class="player-score red">
                <div class="score-bubble" id="scoreP2Display">0</div> <span class="name" id="player2NameDisplay">Pemain 2</span>
            </div>
        </div>
        <div id="gameIdDisplay">Game ID: ---</div>
        <div id="messages" class="hidden-info"></div>
        <div class="board-area">
            <div class="board-container" id="sosBoard"></div>
            <svg id="lineOverlay" class="line-overlay"></svg>
        </div>
        <div id="turnInfoDisplay">Menunggu permainan...</div>
        <div class="game-controls-bottom">
            <span class="label-sos">SOS</span>
            <div class="letter-buttons-bottom">
                <button class="letter-btn-bottom" data-letter="S">S</button>
                <button class="letter-btn-bottom" data-letter="O">O</button>
            </div>
        </div>
        <div class="admin-controls">
            <button id="resetGame">Reset Game</button>
            <button id="leaveGameBtn">Keluar Game</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyP8X-Wom8rFiBTTXni6fcTmwYW00Z5OFnhhcJmqAeb0V5hG_x7Z5SrnEM57N6-o1-R/exec"; // << GANTI INI

        const sosBoardElement = document.getElementById('sosBoard');
        const lineOverlayElement = document.getElementById('lineOverlay');
        const scoreP1DisplayElement = document.getElementById('scoreP1Display');
        const scoreP2DisplayElement = document.getElementById('scoreP2Display');
        const turnInfoDisplayElement = document.getElementById('turnInfoDisplay');
        const player1NameDisplay = document.getElementById('player1NameDisplay');
        const player2NameDisplay = document.getElementById('player2NameDisplay');
        const gameIdDisplayElement = document.getElementById('gameIdDisplay');
        const messagesElement = document.getElementById('messages');

        const letterButtonsBottom = document.querySelectorAll('.letter-btn-bottom');
        const resetGameButton = document.getElementById('resetGame');
        const showAvailableGamesBtn = document.getElementById('showAvailableGamesBtn');
        const joinOrCreateGameBtn = document.getElementById('joinOrCreateGameBtn');
        const leaveGameBtn = document.getElementById('leaveGameBtn');
        const playerNameInput = document.getElementById('playerNameInput');
        const gameIdInput = document.getElementById('gameIdInput');
        const availableGamesDiv = document.getElementById('availableGames');

        const PLAYER1_TEXT_CLASS = 'player1-text';
        const PLAYER2_TEXT_CLASS = 'player2-text';
        const PLAYER1_LINE_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--player1-color-line').trim();
        const PLAYER2_LINE_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--player2-color-line').trim();

        const BOARD_SIZE = 7;
        let localBoardCache = [];
        let gameStateFromServer = {}; // Untuk menyimpan state terakhir dari server, termasuk sosLines
        let selectedLetter = 'S';
        let cellsFilled = 0;
        let lastScoringCellCoords = null;

        let localPlayerName = "";
        let currentGameId = null;
        let localPlayerNumber = 0;
        let pollingInterval = null;
        let isMyTurn = false;

        function showScreen(screenName) {
            document.getElementById('loginSection').style.display = (screenName === 'login') ? 'block' : 'none';
            document.getElementById('gameSection').style.display = (screenName === 'game') ? 'flex' : 'none';
            if (screenName === 'login') {
                 if(pollingInterval) clearInterval(pollingInterval);
                 pollingInterval = null;
                 availableGamesDiv.style.display = 'none';
                 if(gameIdDisplayElement) gameIdDisplayElement.textContent = 'Game ID: ---';
                 if(messagesElement) messagesElement.classList.add('hidden-info');
            } else if (screenName === 'game') {
                requestAnimationFrame(positionLineOverlay);
                if (gameIdDisplayElement && currentGameId) {
                    gameIdDisplayElement.textContent = `Game ID: ${currentGameId}`;
                } else if (gameIdDisplayElement) {
                    gameIdDisplayElement.textContent = `Game ID: ---`;
                }
                if (messagesElement) messagesElement.classList.add('hidden-info');
            }
        }

        function showMessage(text, isError = false) {
            if (!messagesElement) return;
            messagesElement.classList.remove('hidden-info');
            messagesElement.textContent = text;
            messagesElement.style.color = isError ? 'red' : 'green';
            if (text) {
                setTimeout(() => {
                    if(messagesElement.textContent === text) messagesElement.textContent = '';
                    messagesElement.classList.add('hidden-info');
                }, 5000);
            } else {
                 messagesElement.classList.add('hidden-info');
            }
        }

        async function callAppsScript(action, payload = {}, method = 'POST') {
            const url = new URL(SCRIPT_URL);
            let response;
            const buttonsToDisable = [showAvailableGamesBtn, joinOrCreateGameBtn, leaveGameBtn, resetGameButton];
            buttonsToDisable.forEach(btn => { if (btn) btn.disabled = true; });

            try {
                if (method === 'GET') {
                    url.searchParams.append('action', action);
                    for (const key in payload) {
                        url.searchParams.append(key, payload[key]);
                    }
                    response = await fetch(url);
                } else {
                    payload.action = action;
                    response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Network error: ${response.status}. ${errorText}`);
                }
                const data = await response.json();
                if (!data.success &&
                    action !== 'getGames' &&
                    !(action === 'getGameState' && data.error && data.error.includes("Game not found"))
                   ) {
                    throw new Error(data.error || `API call (${action}) failed without specific server error.`);
                }
                return data;
            } catch (error) {
                console.error(`Error in callAppsScript (${action}):`, error.message);
                if (!(action === 'getGameState' && pollingInterval && !error.message.includes("Game not found"))) {
                    showMessage(`Error: ${error.message}`, true);
                }
                throw error;
            } finally {
                 buttonsToDisable.forEach(btn => {
                    if (btn) {
                        // Tombol Reset dan Leave akan di-handle oleh updateUIFromGameState
                        // Tombol login section diaktifkan kembali
                        if (btn === showAvailableGamesBtn || btn === joinOrCreateGameBtn) {
                            btn.disabled = false;
                        }
                        // Untuk leaveGameBtn dan resetGameButton, biarkan updateUIFromGameState yang mengatur final state nya
                    }
                });
            }
        }

        function setActiveLetterButton() {
            letterButtonsBottom.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.letter === selectedLetter) {
                    btn.classList.add('active');
                }
            });
        }
        function initLocalGameUI() {
            selectedLetter = 'S';
            setActiveLetterButton();
            clearLines();
            if(sosBoardElement) sosBoardElement.style.pointerEvents = 'auto';
            if(messagesElement) messagesElement.classList.add('hidden-info');
            if (gameIdDisplayElement && currentGameId) {
                gameIdDisplayElement.textContent = `Game ID: ${currentGameId}`;
            } else if (gameIdDisplayElement) {
                 gameIdDisplayElement.textContent = `Game ID: ---`;
            }
        }

        function renderBoard(boardData, lastMove) {
            if (!sosBoardElement) return;
            sosBoardElement.innerHTML = '';
            sosBoardElement.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;
            sosBoardElement.style.gridTemplateRows = `repeat(${BOARD_SIZE}, 1fr)`;

            const boardWidth = sosBoardElement.offsetWidth;
            let fontSizeForCell = (boardWidth / BOARD_SIZE) * 0.48;
            if (fontSizeForCell < 10) fontSizeForCell = 10;
            if (fontSizeForCell > 32) fontSizeForCell = 32;

            const prevHighlight = sosBoardElement.querySelector('.last-move-highlight');
            if (prevHighlight) prevHighlight.classList.remove('last-move-highlight');
            lastScoringCellCoords = null;

            if (lastMove && lastMove.scored) {
                 lastScoringCellCoords = { r: lastMove.r, c: lastMove.c };
            }

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('board-cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.style.fontSize = `${fontSizeForCell}px`;

                    if (boardData[r][c]) {
                        cell.textContent = boardData[r][c].letter;
                        cell.classList.add(boardData[r][c].player === 1 ? PLAYER1_TEXT_CLASS : PLAYER2_TEXT_CLASS);
                        cell.classList.add('filled');
                        cell.style.cursor = 'default';
                    } else {
                        cell.style.cursor = isMyTurn ? 'pointer' : 'not-allowed';
                    }

                    if (lastScoringCellCoords && lastScoringCellCoords.r === r && lastScoringCellCoords.c === c) {
                        cell.classList.add('last-move-highlight');
                    }

                    cell.addEventListener('click', handleCellClick);
                    sosBoardElement.appendChild(cell);
                }
            }
            if (document.getElementById('gameSection').style.display === 'flex') {
                requestAnimationFrame(positionLineOverlay);
            }
        }

        function positionLineOverlay() {
             if (!sosBoardElement || !lineOverlayElement) return;
            const boardRect = sosBoardElement.getBoundingClientRect();
            if (boardRect.width === 0 && boardRect.height === 0) {
                return;
            }
            const boardAreaRect = sosBoardElement.parentElement.getBoundingClientRect();

            lineOverlayElement.style.position = 'absolute';
            lineOverlayElement.style.top = `${boardRect.top - boardAreaRect.top}px`;
            lineOverlayElement.style.left = `${boardRect.left - boardAreaRect.left}px`;
            lineOverlayElement.style.width = `${boardRect.width}px`;
            lineOverlayElement.style.height = `${boardRect.height}px`;
        }

        function drawSingleSOSLine(points, playerNum) {
            if (!sosBoardElement || !lineOverlayElement || !points || points.length !== 3) {
                console.warn("Invalid data for drawing SOS line:", points);
                return;
            }

            const s1_coords = points[0]; // Misal {r: rowS1, c: colS1}
            const s2_coords = points[2]; // Misal {r: rowS2, c: colS2}

            // Dapatkan elemen DOM sel S1 dan S2 untuk posisi yang paling akurat
            const s1_cell_element = sosBoardElement.querySelector(`.board-cell[data-row='${s1_coords.r}'][data-col='${s1_coords.c}']`);
            const s2_cell_element = sosBoardElement.querySelector(`.board-cell[data-row='${s2_coords.r}'][data-col='${s2_coords.c}']`);

            if (!s1_cell_element || !s2_cell_element) {
                console.warn("Could not find S-cell DOM elements for line drawing.", s1_coords, s2_coords);
                // Fallback ke metode perhitungan jika elemen tidak ditemukan (seharusnya tidak terjadi)
                const boardRectFallback = sosBoardElement.getBoundingClientRect();
                if (boardRectFallback.width === 0 || boardRectFallback.height === 0) return;
                const cellWidthFallback = boardRectFallback.width / BOARD_SIZE;
                const cellHeightFallback = boardRectFallback.height / BOARD_SIZE;
                const getCellCenterFallback = (coord) => ({
                    x: (coord.c + 0.5) * cellWidthFallback,
                    y: (coord.r + 0.5) * cellHeightFallback
                });
                const startPointFallback = getCellCenterFallback(s1_coords);
                const endPointFallback = getCellCenterFallback(s2_coords);
                
                const lineFallback = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                lineFallback.setAttribute('x1', startPointFallback.x.toFixed(2));
                lineFallback.setAttribute('y1', startPointFallback.y.toFixed(2));
                lineFallback.setAttribute('x2', endPointFallback.x.toFixed(2));
                lineFallback.setAttribute('y2', endPointFallback.y.toFixed(2));
                lineFallback.setAttribute('stroke', playerNum === 1 ? PLAYER1_LINE_COLOR : PLAYER2_LINE_COLOR);
                let strokeWidthFallback = Math.max(3.5, Math.min(cellWidthFallback, cellHeightFallback) / 15);
                lineFallback.setAttribute('stroke-width', strokeWidthFallback.toFixed(2));
                lineFallback.setAttribute('stroke-linecap', 'round');
                lineOverlayElement.appendChild(lineFallback);
                return;
            }

            const s1_rect = s1_cell_element.getBoundingClientRect();
            const s2_rect = s2_cell_element.getBoundingClientRect();
            const overlay_rect = lineOverlayElement.getBoundingClientRect(); // Rect dari SVG overlay

            // Hitung titik tengah sel S1 dan S2 relatif terhadap SVG overlay
            const x1 = (s1_rect.left + s1_rect.width / 2) - overlay_rect.left;
            const y1 = (s1_rect.top + s1_rect.height / 2) - overlay_rect.top;
            const x2 = (s2_rect.left + s2_rect.width / 2) - overlay_rect.left;
            const y2 = (s2_rect.top + s2_rect.height / 2) - overlay_rect.top;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1.toFixed(2));
            line.setAttribute('y1', y1.toFixed(2));
            line.setAttribute('x2', x2.toFixed(2));
            line.setAttribute('y2', y2.toFixed(2));

            line.setAttribute('stroke', playerNum === 1 ? PLAYER1_LINE_COLOR : PLAYER2_LINE_COLOR);
            // Menggunakan lebar sel aktual dari getBoundingClientRect untuk skala stroke-width
            const avgCellWidthForStroke = (s1_rect.width + s2_rect.width) / 2;
            const avgCellHeightForStroke = (s1_rect.height + s2_rect.height) / 2;
            let strokeWidth = Math.max(3.5, Math.min(avgCellWidthForStroke, avgCellHeightForStroke) / 15);
            line.setAttribute('stroke-width', strokeWidth.toFixed(2));
            line.setAttribute('stroke-linecap', 'round');

            lineOverlayElement.appendChild(line);
        }


        function updateUIFromGameState(gameState) {
             gameStateFromServer = {...gameState}; // Simpan state terakhir

             if (!gameState || (!gameState.gameId && (!gameState.action || (gameState.action !== 'getGames' && gameState.action !== 'getGameState')))) {
                console.warn("Invalid or incomplete gameState for UI update:", gameState);
                if (gameState && gameState.error === "Game not found" && currentGameId) {
                    showMessage("Game sesi ini tidak ditemukan atau telah berakhir.", true);
                    leaveCurrentGame();
                }
                return;
            }

            currentGameId = gameState.gameId || currentGameId;
            if (gameIdDisplayElement && currentGameId) {
                gameIdDisplayElement.textContent = `Game ID: ${currentGameId}`;
            } else if (gameIdDisplayElement) {
                 gameIdDisplayElement.textContent = `Game ID: ---`;
            }

            if(gameState.board && typeof gameState.scores !== 'undefined') {
                player1NameDisplay.textContent = gameState.player1 ? gameState.player1.name : "Pemain 1";
                player2NameDisplay.textContent = gameState.player2 ? gameState.player2.name : (gameState.gameStatus === "waiting_for_player2" ? "Menunggu..." : "Pemain 2");
                scoreP1DisplayElement.textContent = gameState.scores[1];
                scoreP2DisplayElement.textContent = gameState.scores[2];
                localBoardCache = gameState.board; // Ini hanya board, bukan seluruh gameState
                gameStateFromServer.board = gameState.board; // Simpan board ke state global
                gameStateFromServer.sosLines = gameState.sosLines; // Simpan sosLines juga

                cellsFilled = gameState.cellsFilled;
                isMyTurn = (localPlayerNumber === gameState.currentPlayerNum) && !gameState.gameOver && gameState.gameStatus === "playing";

                renderBoard(gameState.board, gameState.lastMoveDetails);
                clearLines();
                if (gameState.sosLines && gameState.sosLines.length > 0) {
                    gameState.sosLines.forEach(sos => drawSingleSOSLine(sos.points, sos.playerNum));
                }
            }


            let turnText = "";
            let turnColor = 'var(--vs-text-color)';

            if (gameState.gameOver) {
                turnText = gameState.winner === "Draw" ? "Permainan SERI!" : `${gameState.winner} MENANG!`;
                turnColor = gameState.winner === "Draw" ? 'var(--vs-text-color)' : (gameState.winner === (gameState.player1 ? gameState.player1.name : "") ? 'var(--player1-color-text)' : 'var(--player2-color-text)');
                if(sosBoardElement) sosBoardElement.style.pointerEvents = 'none';
                if(pollingInterval) clearInterval(pollingInterval);
                 pollingInterval = null;
            } else if (gameState.gameStatus === "waiting_for_player2") {
                turnText = "Menunggu Pemain 2 bergabung...";
                if(sosBoardElement) sosBoardElement.style.pointerEvents = 'none';
            } else if(gameState.gameStatus === "playing") {
                const currentPlayerDetails = gameState.currentPlayerNum === 1 ? gameState.player1 : gameState.player2;
                turnText = `Giliran: ${currentPlayerDetails ? currentPlayerDetails.name : ('Pemain ' + gameState.currentPlayerNum)}`;
                turnColor = gameState.currentPlayerNum === 1 ? 'var(--player1-color-text)' : 'var(--player2-color-text)';
                if(sosBoardElement) sosBoardElement.style.pointerEvents = isMyTurn ? 'auto' : 'none';
                letterButtonsBottom.forEach(btn => btn.disabled = !isMyTurn);
            } else {
                turnText = "Menunggu permainan...";
            }
            turnInfoDisplayElement.textContent = turnText;
            turnInfoDisplayElement.style.color = turnColor;

            if(resetGameButton) resetGameButton.disabled = !(localPlayerNumber === 1 || gameState.gameOver);
            if(leaveGameBtn) leaveGameBtn.disabled = (!currentGameId && !gameState.gameOver); // Aktif jika ada game atau game selesai
        }


        async function handleJoinOrCreateGame() {
            localPlayerName = playerNameInput.value.trim();
            if (!localPlayerName) {
                showMessage("Masukkan Nama Anda!", true);
                playerNameInput.focus();
                return;
            }
            const gameIdToJoin = gameIdInput.value.trim().toUpperCase();
            try {
                let gs; // gameState
                if (gameIdToJoin) {
                    showMessage("Mencoba bergabung ke game...", false);
                    gs = await callAppsScript('joinGame', { gameId: gameIdToJoin, playerName: localPlayerName });
                } else {
                    showMessage("Membuat game baru...", false);
                    gs = await callAppsScript('createGame', { playerName: localPlayerName });
                }
                currentGameId = gs.gameId;
                localPlayerNumber = gs.playerNum;
                gameStateFromServer = {...gs}; // Simpan state awal

                initLocalGameUI();
                updateUIFromGameState(gs);
                showScreen('game');
                if(pollingInterval) clearInterval(pollingInterval);
                pollingInterval = setInterval(fetchCurrentGameState, 3000);

            } catch (error) {
                console.error("Error in Join/Create: ", error.message);
            }
        }

        async function fetchCurrentGameState() {
            if (!currentGameId || !pollingInterval) return;
            let originalLoginButtonStates = {};
            if (document.getElementById('loginSection').style.display === 'block'){
                if (showAvailableGamesBtn) {originalLoginButtonStates.show = showAvailableGamesBtn.disabled; showAvailableGamesBtn.disabled = true;}
                if (joinOrCreateGameBtn) {originalLoginButtonStates.join = joinOrCreateGameBtn.disabled; joinOrCreateGameBtn.disabled = true;}
            }

            try {
                const gs = await callAppsScript('getGameState', { gameId: currentGameId }, 'GET');
                 if (pollingInterval && gs.success) {
                    updateUIFromGameState(gs);
                } else if (pollingInterval && !gs.success && gs.error && gs.error.includes("Game not found")){
                     showMessage("Sesi game tidak ditemukan atau telah berakhir.", true);
                     leaveCurrentGame();
                }
            } catch (error) { /* Handled by callAppsScript */ }
            finally {
                if (document.getElementById('loginSection').style.display === 'block'){
                    if (showAvailableGamesBtn && typeof originalLoginButtonStates.show !== 'undefined') showAvailableGamesBtn.disabled = originalLoginButtonStates.show;
                    if (joinOrCreateGameBtn && typeof originalLoginButtonStates.join !== 'undefined') joinOrCreateGameBtn.disabled = originalLoginButtonStates.join;
                }
            }
        }
        async function handleCellClick(event) {
            if (!isMyTurn || !currentGameId) return;
            const targetCell = event.target.closest('.board-cell');
            if (!targetCell || targetCell.classList.contains('filled')) return;

            const row = parseInt(targetCell.dataset.row);
            const col = parseInt(targetCell.dataset.col);

            targetCell.textContent = selectedLetter;
            targetCell.classList.add(localPlayerNumber === 1 ? PLAYER1_TEXT_CLASS : PLAYER2_TEXT_CLASS);
            targetCell.classList.add('filled');
            if(sosBoardElement) sosBoardElement.style.pointerEvents = 'none';

            letterButtonsBottom.forEach(btn => btn.disabled = true);
            // resetGameButton dan leaveGameBtn sudah di-disable oleh callAppsScript

            try {
                const gs = await callAppsScript('makeMove', {
                    gameId: currentGameId,
                    playerName: localPlayerName,
                    move: { r: row, c: col, letter: selectedLetter }
                });
                updateUIFromGameState(gs);
            } catch (error) {
                fetchCurrentGameState(); // Revert
                // Jika error, kembalikan state tombol ke sebelum dikunci (jika giliran masih sama)
                // updateUIFromGameState akan mencoba memperbaiki ini, tapi fallback:
                if(isMyTurn) letterButtonsBottom.forEach(btn => btn.disabled = false);
            }
            // Status akhir tombol diatur oleh updateUIFromGameState dan finally di callAppsScript
        }
        async function handleResetGame() {
             if (!currentGameId) return;
            if (!confirm("Yakin ingin mereset game ini?")) return;
            try {
                const gs = await callAppsScript('resetGame', { gameId: currentGameId, playerName: localPlayerName });
                updateUIFromGameState(gs);
                showMessage("Game direset.", false);
                 if (pollingInterval) clearInterval(pollingInterval);
                 if (!gs.gameOver && gs.gameStatus === "playing") {
                    pollingInterval = setInterval(fetchCurrentGameState, 3000);
                 }
            } catch (error) { /* Handled by callAppsScript */ }
        }
        function leaveCurrentGame() {
             if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = null;
            const oldGameId = currentGameId;
            currentGameId = null;
            localPlayerNumber = 0;
            isMyTurn = false;
            gameStateFromServer = {}; // Reset state
            showScreen('login');
            if(gameIdInput) gameIdInput.value = "";
            if(messagesElement) messagesElement.classList.add('hidden-info');
            if(availableGamesDiv) availableGamesDiv.style.display = 'none';
            if(turnInfoDisplayElement) turnInfoDisplayElement.textContent = "Menunggu permainan...";
            if(scoreP1DisplayElement) scoreP1DisplayElement.textContent = "0";
            if(scoreP2DisplayElement) scoreP2DisplayElement.textContent = "0";
            if(player1NameDisplay) player1NameDisplay.textContent = "Pemain 1";
            if(player2NameDisplay) player2NameDisplay.textContent = "Pemain 2";
            if(sosBoardElement) sosBoardElement.innerHTML = "";
            clearLines();
            showMessage(`Anda telah keluar dari game ${oldGameId || ""}.`);
        }

        async function fetchAvailableGames() {
            if(!availableGamesDiv) return;
            availableGamesDiv.innerHTML = '<p><i>Memuat daftar game...</i></p>';
            try {
                const data = await callAppsScript('getGames', {}, 'GET');
                if (data.success && data.games && data.games.length > 0) {
                    let gameListHtml = '<ul>';
                    data.games.forEach(g => {
                        let joinButtonHtml = '';
                        if (g.status === 'waiting_for_player2' && !g.player2) {
                            joinButtonHtml = `<button class="join-lobby-btn" data-gameid="${g.gameId}">Gabung</button>`;
                        }
                        gameListHtml += `<li><span>ID: ${g.gameId} (P1: ${g.player1 || '?'}, P2: ${g.player2 || (g.status === 'waiting_for_player2' ? 'Kosong' : '?')}) - ${g.status}</span> ${joinButtonHtml}</li>`;
                    });
                    gameListHtml += '</ul>';
                    availableGamesDiv.innerHTML = gameListHtml;

                    document.querySelectorAll('.join-lobby-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const gameIdFromLobby = e.target.dataset.gameid;
                            if(gameIdInput) gameIdInput.value = gameIdFromLobby;
                            localPlayerName = playerNameInput.value.trim();
                            if (!localPlayerName) {
                                showMessage("Masukkan Nama Anda terlebih dahulu untuk bergabung dari lobi!", true);
                                playerNameInput.focus();
                                return;
                            }
                            handleJoinOrCreateGame();
                        });
                    });
                } else {
                    availableGamesDiv.innerHTML = '<p><i>Tidak ada game tersedia. Buat yang baru!</i></p>';
                }
            } catch (error) {
                 if(availableGamesDiv) availableGamesDiv.innerHTML = `<p><i>Gagal memuat game. ${error.message}</i></p>`;
            }
        }

        function clearLines() {
            if (lineOverlayElement) lineOverlayElement.innerHTML = '';
        }

        letterButtonsBottom.forEach(button => {
            button.addEventListener('click', () => {
                if (!isMyTurn) return;
                selectedLetter = button.dataset.letter;
                setActiveLetterButton();
            });
        });

        if(showAvailableGamesBtn) showAvailableGamesBtn.addEventListener('click', () => {
            if (availableGamesDiv.style.display === 'none' || availableGamesDiv.style.display === '') {
                availableGamesDiv.style.display = 'block';
                fetchAvailableGames();
            } else {
                availableGamesDiv.style.display = 'none';
            }
        });
        if(joinOrCreateGameBtn) joinOrCreateGameBtn.addEventListener('click', handleJoinOrCreateGame);
        if(resetGameButton) resetGameButton.addEventListener('click', handleResetGame);
        if(leaveGameBtn) leaveGameBtn.addEventListener('click', leaveCurrentGame);

        document.addEventListener('DOMContentLoaded', () => {
            showScreen('login');
            setActiveLetterButton();
            window.addEventListener('resize', () => {
                if (document.getElementById('gameSection').style.display === 'flex') {
                    requestAnimationFrame(() => {
                        positionLineOverlay();
                        if(currentGameId && gameStateFromServer.board && gameStateFromServer.board.length > 0) {
                             renderBoard(gameStateFromServer.board, gameStateFromServer.lastMoveDetails);
                             clearLines();
                             if (gameStateFromServer.sosLines && gameStateFromServer.sosLines.length > 0) {
                                gameStateFromServer.sosLines.forEach(sos => drawSingleSOSLine(sos.points, sos.playerNum));
                             }
                        } else if (typeof fetchCurrentGameState === "function") { // Jika tidak ada state, coba fetch
                            // fetchCurrentGameState(); // Hati-hati, ini bisa menyebabkan loop jika resize sering terjadi
                        }
                    });
                }
            });
        });
    </script>

</body></html>
